<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Court Reservations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .credentials-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .credentials-section h3 {
            margin-bottom: 15px;
            color: #4a5568;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-field {
            margin-bottom: 15px;
        }

        .form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .form-field input,
        .form-field select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-field input:focus,
        .form-field select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .route-description {
            background: #edf2f7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            color: #4a5568;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #718096;
            margin-top: 0;
            padding: 10px 20px;
            width: auto;
        }

        .btn-danger {
            background: #f56565;
        }

        .results {
            margin-top: 20px;
        }

        .result-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .result-message.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        .result-message.error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        .result-message.info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }

        .reservations-list {
            margin-top: 15px;
        }

        .reservation-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reservation-item.success {
            border-left: 4px solid #38a169;
        }

        .reservation-item.failed {
            border-left: 4px solid #f56565;
        }

        .job-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .job-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .job-type.one-time {
            background: #bee3f8;
            color: #2c5282;
        }

        .job-type.recurring {
            background: #feebc8;
            color: #7c2d12;
        }

        .job-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .job-status.scheduled { background: #bee3f8; color: #2c5282; }
        .job-status.running { background: #feebc8; color: #7c2d12; }
        .job-status.retrying { background: #fbd38d; color: #744210; }
        .job-status.completed { background: #c6f6d5; color: #22543d; }
        .job-status.failed { background: #fed7d7; color: #742a2a; }
        .job-status.cancelled { background: #e2e8f0; color: #4a5568; }
        .job-status.expired { background: #e2e8f0; color: #4a5568; }

        .job-details {
            font-size: 0.9rem;
            color: #4a5568;
            margin-top: 8px;
        }

        .job-details div {
            margin-bottom: 4px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #718096;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .input-group {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéæ Rezerwacje Kort√≥w - Zatoka Sportu</h1>
            <p>Rezerwuj korty tenisowe z ≈Çatwo≈õciƒÖ</p>
        </div>

        <!-- Credentials Card -->
        <div class="card">
            <div class="credentials-section">
                <h3>Twoje Dane Logowania</h3>
                <p style="margin-bottom: 15px; font-size: 0.9rem; color: #4a5568;">
                    U≈ºyj danych z konta Zatoka Sportu (<a href="https://klient.zatokasportu.pl" target="_blank" style="color: #667eea;">klient.zatokasportu.pl</a>)
                </p>
                <div class="input-group">
                    <div class="form-field">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="twoj@email.com" required>
                    </div>
                    <div class="form-field">
                        <label for="password">Has≈Ço</label>
                        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                </div>
            </div>

            <!-- Route Selection Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('continuous')">Zarezerwuj Teraz</button>
                <button class="tab" onclick="switchTab('find-slot')">Znajd≈∫ Termin</button>
                <button class="tab" onclick="switchTab('watch')">Obserwuj Anulowania</button>
            </div>

            <!-- Tab 1: Continuous Reservation -->
            <div id="continuous-tab" class="tab-content active">
                <div class="route-description">
                    Rezerwuj ciƒÖg≈Çe godziny na tym samym korcie. Je≈õli termin jest dalej ni≈º 15 dni, zaplanujemy rezerwacjƒô automatycznie.
                </div>
                <div class="form-field">
                    <label for="cont-date">Data</label>
                    <small style="display: block; color: #718096; margin-bottom: 5px;">Wybierz dzie≈Ñ rezerwacji</small>
                    <input type="date" id="cont-date" required>
                </div>
                <div class="input-group">
                    <div class="form-field">
                        <label for="cont-time">Godzina Rozpoczƒôcia</label>
                        <small style="display: block; color: #718096; margin-bottom: 5px;">Od kt√≥rej godziny szukaƒá wolnych termin√≥w (tylko XX:30)</small>
                        <select id="cont-time" required>
                            <option value="">Wybierz godzinƒô...</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="cont-hours">Liczba Godzin (wymagane)</label>
                        <small style="display: block; color: #718096; margin-bottom: 5px;">Ile godzin chcesz zarezerwowaƒá</small>
                        <select id="cont-hours" required>
                            <option value="">Wybierz...</option>
                            <option value="1">1 godzina</option>
                            <option value="2">2 godziny</option>
                            <option value="3">3 godziny</option>
                            <option value="4">4 godziny</option>
                            <option value="5">5 godzin</option>
                            <option value="6">6 godzin</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="cont-end-time">Godzina Zako≈Ñczenia (opcjonalnie)</label>
                        <small style="display: block; color: #718096; margin-bottom: 5px;">G√≥rny limit przedzia≈Çu czasowego - np. dla 2h miƒôdzy 6:30 a 12:30</small>
                        <select id="cont-end-time">
                            <option value="">Brak limitu...</option>
                        </select>
                    </div>
                </div>
                <div class="form-field">
                    <label for="cont-courts">Liczba Kort√≥w (1-4)</label>
                    <small style="display: block; color: #718096; margin-bottom: 5px;">Ile kort√≥w jednocze≈õnie (najlepiej sƒÖsiadujƒÖce)</small>
                    <input type="number" id="cont-courts" min="1" max="4" value="1" required>
                </div>
                <button class="btn" onclick="submitContinuous()" id="btn-continuous">Zarezerwuj</button>
            </div>

            <!-- Tab 2: Find Slot -->
            <div id="find-slot-tab" class="tab-content">
                <div class="route-description">
                    Znajd≈∫ pierwszy dostƒôpny ciƒÖg≈Çy termin w ciƒÖgu najbli≈ºszych 15 dni. System automatycznie przeszuka kolejne dni.
                </div>
                <div class="form-field">
                    <label for="find-date">Data PoczƒÖtkowa (opcjonalnie)</label>
                    <small style="display: block; color: #718096; margin-bottom: 5px;">Zostaw puste aby zaczƒÖƒá od dzisiaj</small>
                    <input type="date" id="find-date">
                </div>
                <div class="input-group">
                    <div class="form-field">
                        <label for="find-time">Godzina Rozpoczƒôcia</label>
                        <small style="display: block; color: #718096; margin-bottom: 5px;">Od kt√≥rej godziny szukaƒá wolnych termin√≥w (tylko XX:30)</small>
                        <select id="find-time" required>
                            <option value="">Wybierz godzinƒô...</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="find-hours">Liczba Godzin (wymagane)</label>
                        <small style="display: block; color: #718096; margin-bottom: 5px;">Ile kolejnych godzin potrzebujesz</small>
                        <select id="find-hours" required>
                            <option value="">Wybierz...</option>
                            <option value="1">1 godzina</option>
                            <option value="2">2 godziny</option>
                            <option value="3">3 godziny</option>
                            <option value="4">4 godziny</option>
                            <option value="5">5 godzin</option>
                            <option value="6">6 godzin</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="find-end-time">Godzina Zako≈Ñczenia (opcjonalnie)</label>
                        <small style="display: block; color: #718096; margin-bottom: 5px;">G√≥rny limit przedzia≈Çu czasowego - np. dla 2h miƒôdzy 6:30 a 12:30</small>
                        <select id="find-end-time">
                            <option value="">Brak limitu...</option>
                        </select>
                    </div>
                </div>
                <div class="form-field">
                    <label for="find-courts">Liczba Kort√≥w (1-4)</label>
                    <small style="display: block; color: #718096; margin-bottom: 5px;">Ile kort√≥w jednocze≈õnie</small>
                    <input type="number" id="find-courts" min="1" max="4" value="1" required>
                </div>
                <button class="btn" onclick="submitFindSlot()" id="btn-find">Znajd≈∫ i Zarezerwuj</button>
            </div>

            <!-- Tab 3: Watch for Cancellations -->
            <div id="watch-tab" class="tab-content">
                <div class="route-description">
                    Stw√≥rz obserwator kt√≥ry sprawdza dostƒôpno≈õƒá co 30 minut. Automatycznie rezerwuje gdy znajdzie wolny termin!
                </div>
                <div class="form-field">
                    <label for="watch-date">Data</label>
                    <small style="display: block; color: #718096; margin-bottom: 5px;">Wybierz dzie≈Ñ kt√≥ry chcesz obserwowaƒá</small>
                    <input type="date" id="watch-date" required>
                </div>
                <div class="input-group">
                    <div class="form-field">
                        <label for="watch-time">Godzina Rozpoczƒôcia</label>
                        <small style="display: block; color: #718096; margin-bottom: 5px;">Od kt√≥rej godziny obserwowaƒá (tylko XX:30)</small>
                        <select id="watch-time" required>
                            <option value="">Wybierz godzinƒô...</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="watch-hours">Liczba Godzin (wymagane)</label>
                        <small style="display: block; color: #718096; margin-bottom: 5px;">Ile godzin potrzebujesz</small>
                        <select id="watch-hours" required>
                            <option value="">Wybierz...</option>
                            <option value="1">1 godzina</option>
                            <option value="2">2 godziny</option>
                            <option value="3">3 godziny</option>
                            <option value="4">4 godziny</option>
                            <option value="5">5 godzin</option>
                            <option value="6">6 godzin</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="watch-end-time">Godzina Zako≈Ñczenia (opcjonalnie)</label>
                        <small style="display: block; color: #718096; margin-bottom: 5px;">G√≥rny limit przedzia≈Çu czasowego - np. dla 2h miƒôdzy 6:30 a 12:30</small>
                        <select id="watch-end-time">
                            <option value="">Brak limitu...</option>
                        </select>
                    </div>
                </div>
                <div class="form-field">
                    <label for="watch-courts">Liczba Kort√≥w (1-4)</label>
                    <small style="display: block; color: #718096; margin-bottom: 5px;">Ile kort√≥w jednocze≈õnie</small>
                    <input type="number" id="watch-courts" min="1" max="4" value="1" required>
                </div>
                <button class="btn" onclick="submitWatch()" id="btn-watch">Uruchom Obserwator</button>
            </div>
        </div>

        <!-- Reservation Results Card -->
        <div class="card" id="results-card" style="display: none;">
            <h2>Wyniki Rezerwacji</h2>
            <div id="results" class="results"></div>
        </div>

        <!-- Scheduled Jobs Card -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Zaplanowane Zadania</h2>
                <button class="btn btn-secondary" onclick="loadJobs()">üîÑ Od≈õwie≈º</button>
            </div>
            <div id="jobs-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>≈Åadowanie zada≈Ñ...</p>
                </div>
            </div>
        </div>

        <!-- Test Cancel Reservation Card -->
        <div class="card">
            <h2>üß™ Test - Anuluj Rezerwacjƒô</h2>
            <p style="color: #718096; margin-bottom: 20px;">Testowe narzƒôdzie do anulowania rezerwacji po ID</p>
            <div class="form-field">
                <label for="test-reservation-id">ID Rezerwacji</label>
                <input type="text" id="test-reservation-id" placeholder="np. 3472763" required>
            </div>
            <button class="btn btn-danger" onclick="testCancelReservation()">Anuluj Rezerwacjƒô</button>
            <div id="test-cancel-result" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        // Populate time selects with XX:30 times
        function populateTimeSelects() {
            // Start time selects (06:30 - 20:30)
            const startTimeSelects = ['cont-time', 'find-time', 'watch-time'];
            startTimeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                for (let hour = 6; hour <= 20; hour++) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:30`;
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.textContent = timeStr;
                    select.appendChild(option);
                }
            });

            // End time selects (07:30 - 21:30, adjusted for Sunday to 20:30)
            const endTimeSelects = ['cont-end-time', 'find-end-time', 'watch-end-time'];
            endTimeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                for (let hour = 7; hour <= 21; hour++) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:30`;
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.textContent = timeStr;
                    select.appendChild(option);
                }
            });
        }

        // Update end time options based on selected date (Sunday has max 20:30)
        function updateEndTimeForDate(dateFieldId, endTimeFieldId) {
            const dateField = document.getElementById(dateFieldId);
            const endTimeField = document.getElementById(endTimeFieldId);

            if (!dateField.value) return;

            const selectedDate = new Date(dateField.value + 'T00:00:00');
            const isSunday = selectedDate.getDay() === 0;

            // Save current value
            const currentValue = endTimeField.value;

            // Clear and repopulate
            endTimeField.innerHTML = '<option value="">Brak limitu...</option>';

            const maxHour = isSunday ? 20 : 21;
            for (let hour = 7; hour <= maxHour; hour++) {
                const timeStr = `${hour.toString().padStart(2, '0')}:30`;
                const option = document.createElement('option');
                option.value = timeStr;
                option.textContent = timeStr;
                endTimeField.appendChild(option);
            }

            // Restore value if still valid
            if (currentValue && parseInt(currentValue.split(':')[0]) <= maxHour) {
                endTimeField.value = currentValue;
            }
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cont-date').value = today;
            document.getElementById('watch-date').value = today;
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Clear results
            document.getElementById('results').innerHTML = '';
        }

        // API calls
        async function submitContinuous() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const date = document.getElementById('cont-date').value;
            const time = document.getElementById('cont-time').value;
            const hours = parseInt(document.getElementById('cont-hours').value);
            const end_time = document.getElementById('cont-end-time').value || null;
            const num_courts = parseInt(document.getElementById('cont-courts').value);

            if (!email || !password || !date || !time || !hours || !num_courts) {
                showError('Proszƒô wype≈Çniƒá wszystkie wymagane pola');
                return;
            }

            const btn = document.getElementById('btn-continuous');
            btn.disabled = true;
            btn.textContent = 'Rezerwujƒô...';

            try {
                const formattedDate = formatDate(date);
                const body = { email, password, date: formattedDate, start_time: time, hours, num_courts };
                if (end_time) {
                    body.end_time = end_time;
                }

                const response = await fetch('/api/reservations/continuous', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                displayResults(data);
                loadJobs();
            } catch (error) {
                showError('B≈ÇƒÖd ≈ºƒÖdania: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Zarezerwuj';
            }
        }

        async function submitFindSlot() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const date = document.getElementById('find-date').value;
            const time = document.getElementById('find-time').value;
            const hours = parseInt(document.getElementById('find-hours').value);
            const end_time = document.getElementById('find-end-time').value || null;
            const num_courts = parseInt(document.getElementById('find-courts').value);

            if (!email || !password || !time || !hours || !num_courts) {
                showError('Proszƒô wype≈Çniƒá wszystkie wymagane pola');
                return;
            }

            const btn = document.getElementById('btn-find');
            btn.disabled = true;
            btn.textContent = 'Szukam...';

            try {
                const body = { email, password, start_time: time, hours, num_courts };
                if (date) {
                    body.date = formatDate(date);
                }
                if (end_time) {
                    body.end_time = end_time;
                }

                const response = await fetch('/api/reservations/find-slot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                displayResults(data);
                loadJobs();
            } catch (error) {
                showError('B≈ÇƒÖd ≈ºƒÖdania: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Znajd≈∫ i Zarezerwuj';
            }
        }

        async function submitWatch() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const date = document.getElementById('watch-date').value;
            const time = document.getElementById('watch-time').value;
            const hours = parseInt(document.getElementById('watch-hours').value);
            const end_time = document.getElementById('watch-end-time').value || null;
            const num_courts = parseInt(document.getElementById('watch-courts').value);

            if (!email || !password || !date || !time || !hours || !num_courts) {
                showError('Proszƒô wype≈Çniƒá wszystkie wymagane pola');
                return;
            }

            const btn = document.getElementById('btn-watch');
            btn.disabled = true;
            btn.textContent = 'Uruchamiam...';

            try {
                const formattedDate = formatDate(date);
                const body = { email, password, date: formattedDate, start_time: time, hours, num_courts };
                if (end_time) {
                    body.end_time = end_time;
                }

                const response = await fetch('/api/reservations/watch-for-cancellations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                displayResults(data);
                loadJobs();
            } catch (error) {
                showError('B≈ÇƒÖd ≈ºƒÖdania: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Uruchom Obserwator';
            }
        }

        async function loadJobs() {
            const email = document.getElementById('email').value;
            if (!email) {
                document.getElementById('jobs-container').innerHTML =
                    '<div class="empty-state">Wprowad≈∫ email aby zobaczyƒá zadania</div>';
                return;
            }

            document.getElementById('jobs-container').innerHTML =
                '<div class="loading"><div class="spinner"></div><p>≈Åadowanie zada≈Ñ...</p></div>';

            try {
                const response = await fetch(`/api/reservations/jobs?email=${encodeURIComponent(email)}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('jobs-container').innerHTML =
                        `<div class="empty-state">B≈ÇƒÖd ≈Çadowania zada≈Ñ: ${data.message}</div>`;
                    return;
                }

                displayJobs(data.jobs);
            } catch (error) {
                document.getElementById('jobs-container').innerHTML =
                    `<div class="empty-state">Nie uda≈Ço siƒô za≈Çadowaƒá zada≈Ñ: ${error.message}</div>`;
            }
        }

        async function cancelJob(jobId) {
            if (!confirm('Czy na pewno chcesz anulowaƒá to zadanie?')) {
                return;
            }

            try {
                const response = await fetch(`/api/reservations/job/${jobId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.error) {
                    alert('Nie uda≈Ço siƒô anulowaƒá zadania: ' + data.message);
                } else {
                    loadJobs();
                }
            } catch (error) {
                alert('Nie uda≈Ço siƒô anulowaƒá zadania: ' + error.message);
            }
        }

        async function testCancelReservation() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const reservationId = document.getElementById('test-reservation-id').value;
            const resultDiv = document.getElementById('test-cancel-result');

            if (!email || !password) {
                resultDiv.innerHTML = '<div class="result-message error">Wprowad≈∫ email i has≈Ço w g√≥rnej sekcji</div>';
                return;
            }

            if (!reservationId) {
                resultDiv.innerHTML = '<div class="result-message error">Wprowad≈∫ ID rezerwacji</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Anulowanie...</p></div>';

            try {
                const response = await fetch('/api/reservations/test/cancel-reservation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        email: email,
                        password: password,
                        reservation_id: reservationId
                    })
                });

                const data = await response.json();

                const messageClass = data.error ? 'error' : 'success';
                const icon = data.cancelled ? '‚úÖ' : '‚ùå';

                resultDiv.innerHTML = `
                    <div class="result-message ${messageClass}">
                        ${icon} ${data.message}
                        <br><small>ID: ${data.reservation_id}</small>
                        ${data.status_code ? `<br><small>Status Code: ${data.status_code}</small>` : ''}
                    </div>
                `;

                // Reload jobs if successful
                if (data.cancelled) {
                    setTimeout(loadJobs, 1000);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result-message error">B≈ÇƒÖd: ${error.message}</div>`;
            }
        }

        // Display functions
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const resultsCard = document.getElementById('results-card');
            let html = '';

            // Show the results card
            resultsCard.style.display = 'block';

            // Message
            const messageClass = data.error ? 'error' : 'success';
            html += `<div class="result-message ${messageClass}">${data.message}</div>`;

            // Calculate actual hours and courts from reservations
            let actualHours = 0;
            let actualCourts = 0;
            if (data.reservations && data.reservations.length > 0) {
                // Count unique time slots (hours)
                const uniqueTimeSlots = new Set(data.reservations.map(r => r.time_slot));
                actualHours = uniqueTimeSlots.size;

                // Count unique courts used at any given time
                const courtsPerTimeSlot = {};
                data.reservations.forEach(r => {
                    if (!courtsPerTimeSlot[r.time_slot]) {
                        courtsPerTimeSlot[r.time_slot] = new Set();
                    }
                    courtsPerTimeSlot[r.time_slot].add(r.court);
                });
                actualCourts = Math.max(...Object.values(courtsPerTimeSlot).map(s => s.size));
            }

            // Stats with actual values
            if (data.stats) {
                const statsHtml = actualHours > 0
                    ? `‚úÖ Udane: ${data.stats.successful} (${actualHours}h na ${actualCourts} ${actualCourts === 1 ? 'korcie' : 'kortach'}) | ‚ùå Nieudane: ${data.stats.failed} | üìÖ Zaplanowane: ${data.stats.scheduled}`
                    : `‚úÖ Udane: ${data.stats.successful} | ‚ùå Nieudane: ${data.stats.failed} | üìÖ Zaplanowane: ${data.stats.scheduled}`;

                html += `<div class="result-message info">${statsHtml}</div>`;
            }

            // Reservations
            if (data.reservations && data.reservations.length > 0) {
                html += '<div class="reservations-list"><h3>Wykonane Rezerwacje</h3>';
                data.reservations.forEach(res => {
                    const statusClass = res.success ? 'success' : 'failed';
                    const icon = res.success ? '‚úÖ' : '‚ùå';
                    html += `
                        <div class="reservation-item ${statusClass}">
                            <div>
                                <strong>${res.date} ${res.time_slot}</strong> - Kort ${res.court}
                                ${res.error_message ? `<br><small style="color: #e53e3e;">${res.error_message}</small>` : ''}
                            </div>
                            <div>${icon}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Scheduled jobs info in results
            if (data.scheduled_jobs && data.scheduled_jobs.length > 0) {
                const job = data.scheduled_jobs[0];
                const jobHours = job.hours || 0;
                const jobCourts = job.num_courts || 1;
                const hourLabel = jobHours === 1 ? 'godzinƒô' : (jobHours < 5 ? 'godziny' : 'godzin');
                const courtLabel = jobCourts === 1 ? 'kort' : (jobCourts < 5 ? 'korty' : 'kort√≥w');

                html += '<div class="result-message info" style="margin-top: 15px;">';
                html += `<strong>üìÖ Zaplanowano zadanie: ${jobHours} ${hourLabel} na ${jobCourts} ${courtLabel}</strong><br>`;
                html += 'Sprawd≈∫ sekcjƒô "Zaplanowane Zadania" poni≈ºej aby zobaczyƒá szczeg√≥≈Çy i zarzƒÖdzaƒá nimi.';
                html += '</div>';
            }

            resultsDiv.innerHTML = html;

            // Scroll to results
            resultsCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function displayJobs(jobs) {
            const container = document.getElementById('jobs-container');

            if (!jobs || jobs.length === 0) {
                container.innerHTML = '<div class="empty-state">Brak zaplanowanych zada≈Ñ</div>';
                return;
            }

            // Polish translations for job types and statuses
            const jobTypeLabels = {
                'one-time': 'jednorazowe',
                'recurring': 'cykliczne'
            };
            const statusLabels = {
                'scheduled': 'zaplanowane',
                'running': 'w trakcie',
                'retrying': 'ponowna pr√≥ba',
                'completed': 'uko≈Ñczone',
                'failed': 'nieudane',
                'cancelled': 'anulowane',
                'expired': 'wygas≈Çe'
            };

            let html = '';
            jobs.forEach(job => {
                const canCancel = ['scheduled', 'running', 'retrying'].includes(job.status);
                const courts = job.num_courts || 1;
                const jobTypeLabel = jobTypeLabels[job.job_type] || job.job_type;
                const statusLabel = statusLabels[job.status] || job.status;
                const hourLabel = job.hours === 1 ? 'godzina' : (job.hours < 5 ? 'godziny' : 'godzin');
                const courtLabel = courts === 1 ? 'kort' : (courts < 5 ? 'korty' : 'kort√≥w');

                html += `
                    <div class="job-item">
                        <div class="job-header">
                            <div>
                                <span class="job-type ${job.job_type}">${jobTypeLabel}</span>
                                <span class="job-status ${job.status}">${statusLabel}</span>
                            </div>
                            ${canCancel ? `<button class="btn btn-danger" onclick="cancelJob('${job.job_id}')">Anuluj</button>` : ''}
                        </div>
                        <div class="job-details">
                            <div><strong>ID zadania:</strong> ${job.job_id}</div>
                            <div><strong>Rezerwacja:</strong> ${formatDateTime(job.reservation_datetime)}</div>
                            <div><strong>Czas:</strong> ${job.hours} ${hourLabel} na ${courts} ${courtLabel}</div>
                            <div><strong>Nastƒôpne uruchomienie:</strong> ${formatDateTime(job.scheduled_for || job.run_time)}</div>
                            ${job.check_count ? `<div><strong>Wykonane sprawdzenia:</strong> ${job.check_count}</div>` : ''}
                            ${job.last_check ? `<div><strong>Ostatnie sprawdzenie:</strong> ${formatDateTime(job.last_check)}</div>` : ''}
                            ${job.retry_count ? `<div><strong>Liczba pr√≥b:</strong> ${job.retry_count}</div>` : ''}
                            ${job.next_retry ? `<div><strong>Nastƒôpna pr√≥ba:</strong> ${formatDateTime(job.next_retry)}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function showError(message) {
            const resultsDiv = document.getElementById('results');
            const resultsCard = document.getElementById('results-card');
            resultsCard.style.display = 'block';
            resultsDiv.innerHTML = `<div class="result-message error">${message}</div>`;
        }

        // Utility functions
        function formatDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}-${month}-${year}`;
        }

        function formatDateTime(isoStr) {
            if (!isoStr) return 'N/A';
            const date = new Date(isoStr);
            return date.toLocaleString();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateTimeSelects();
            setDefaultDates();

            // Add event listeners for date changes to update end time options
            document.getElementById('cont-date').addEventListener('change', () => {
                updateEndTimeForDate('cont-date', 'cont-end-time');
            });
            document.getElementById('find-date').addEventListener('change', () => {
                updateEndTimeForDate('find-date', 'find-end-time');
            });
            document.getElementById('watch-date').addEventListener('change', () => {
                updateEndTimeForDate('watch-date', 'watch-end-time');
            });

            // Initialize end times based on default dates
            updateEndTimeForDate('cont-date', 'cont-end-time');
            updateEndTimeForDate('watch-date', 'watch-end-time');

            // Load jobs after a short delay to let user enter email
            setTimeout(() => {
                const email = document.getElementById('email').value;
                if (email) loadJobs();
            }, 500);
        });
    </script>
</body>
</html>
